Option Explicit

' Target folder name (under Inbox, anywhere in subtree)
Private Const TARGET_FOLDER_NAME As String = "CaseCouncil"

' If you want to restrict matching ONLY to Subject, keep SUBJECT_ONLY = True.
' If you want to also match Sender/Body, set to False.
Private Const SUBJECT_ONLY As Boolean = True

Public Sub MoveToCaseCouncil_BySubject_NewestToOldest()
    On Error GoTo EH

    Dim ns As Outlook.NameSpace
    Set ns = Application.GetNamespace("MAPI")

    ' Source folder: default Inbox
    Dim inbox As Outlook.MAPIFolder
    Set inbox = ns.GetDefaultFolder(olFolderInbox)

    ' Target folder: Inbox\CaseCouncil (or nested anywhere under Inbox)
    Dim target As Outlook.MAPIFolder
    Set target = GetFolderUnderRoot(inbox, TARGET_FOLDER_NAME)

    If target Is Nothing Then
        MsgBox "Folder '" & TARGET_FOLDER_NAME & "' not found under: " & inbox.FolderPath, vbExclamation
        Exit Sub
    End If

    ' Subject tokens to match (case-insensitive)
    Dim tokens As Variant
    tokens = Array( _
        "Case Council Deutschland", _
        "Weekly High Value Liste AT, CH, DE_2026" _
    )

    ' Sort by ReceivedTime (descending = newest first)
    Dim items As Outlook.items
    Set items = inbox.items
    items.Sort "[ReceivedTime]", True

    ' Capture EntryIDs first (avoids skipping items when moving)
    Dim countItems As Long
    countItems = items.Count

    Dim ids() As String
    If countItems > 0 Then ReDim ids(1 To countItems)

    Dim i As Long
    For i = 1 To countItems
        Dim o As Object
        Set o = items.Item(i)
        If Not o Is Nothing Then
            On Error Resume Next
            ids(i) = o.EntryID
            On Error GoTo EH
        End If
    Next i

    Dim moved As Long
    moved = 0

    ' Process newest -> oldest
    For i = 1 To countItems
        If Len(ids(i)) > 0 Then
            Dim itm As Object
            Set itm = ns.GetItemFromID(ids(i))

            If Not itm Is Nothing Then
                If TypeName(itm) = "MailItem" Then
                    Dim mail As Outlook.MailItem
                    Set mail = itm

                    If MailMatchesAnyToken(mail, tokens, SUBJECT_ONLY) Then
                        mail.Move target
                        moved = moved + 1
                    End If
                End If
            End If
        End If
    Next i

    MsgBox "Done. Moved " & moved & " email(s) to '" & target.FolderPath & "' (newest to oldest).", vbInformation
    Exit Sub

EH:
    MsgBox "Error " & Err.Number & ": " & Err.Description, vbExclamation
End Sub

' =========================
' Matching logic
' =========================
Private Function MailMatchesAnyToken(ByVal mail As Outlook.MailItem, ByVal tokens As Variant, ByVal subjectOnly As Boolean) As Boolean
    On Error GoTo EH

    Dim haystack As String
    If subjectOnly Then
        haystack = mail.Subject
    Else
        haystack = ""
        haystack = haystack & " " & GetSenderSmtpAddress(mail)
        haystack = haystack & " " & mail.SenderName
        haystack = haystack & " " & mail.Subject
        haystack = haystack & " " & mail.Body
    End If

    Dim t As Variant
    For Each t In tokens
        If InStr(1, haystack, CStr(t), vbTextCompare) > 0 Then
            MailMatchesAnyToken = True
            Exit Function
        End If
    Next t

    MailMatchesAnyToken = False
    Exit Function

EH:
    MailMatchesAnyToken = False
End Function

Private Function GetSenderSmtpAddress(ByVal mail As Outlook.MailItem) As String
    On Error GoTo EH

    Dim smtp As String
    smtp = ""

    On Error Resume Next
    smtp = mail.SenderEmailAddress
    On Error GoTo EH

    If InStr(1, smtp, "/O=", vbTextCompare) > 0 Or InStr(1, smtp, "EX", vbTextCompare) > 0 Then
        Dim pa As Outlook.PropertyAccessor
        Set pa = mail.PropertyAccessor
        smtp = CStr(pa.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x39FE001E")) ' PR_SMTP_ADDRESS
    End If

    GetSenderSmtpAddress = smtp
    Exit Function

EH:
    GetSenderSmtpAddress = ""
End Function

' =========================
' Folder helpers
' =========================
Private Function GetFolderUnderRoot(ByVal root As Outlook.MAPIFolder, ByVal folderName As String) As Outlook.MAPIFolder
    On Error Resume Next

    Set GetFolderUnderRoot = root.Folders(folderName)
    If Not GetFolderUnderRoot Is Nothing Then Exit Function

    Set GetFolderUnderRoot = FindFolderRecursive(root, folderName)
End Function

Private Function FindFolderRecursive(ByVal root As Outlook.MAPIFolder, ByVal nameToFind As String) As Outlook.MAPIFolder
    Dim child As Outlook.MAPIFolder

    For Each child In root.Folders
        If LCase$(child.Name) = LCase$(nameToFind) Then
            Set FindFolderRecursive = child
            Exit Function
        End If

        Dim hit As Outlook.MAPIFolder
        Set hit = FindFolderRecursive(child, nameToFind)
        If Not hit Is Nothing Then
            Set FindFolderRecursive = hit
            Exit Function
        End If
    Next child

    Set FindFolderRecursive = Nothing
End Function
